<!-- Model Personal -->

<!-- Modal change information personal -->
<!-- Button trigger modal -->
<!-- <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
    Launch demo modal
</button> -->

<!-- Modal Dialog Change Information -->
<div class="modal fade" id="modal-personal" tabindex="-1" aria-labelledby="modal-personalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-personalLabel">Thông tin tài khoản</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Body Left -->
                <div class="general-info">
                    <!-- <img id='avt'
                        src="https://images.unsplash.com/photo-1597223557154-721c1cecc4b0?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxzZWFyY2h8Mnx8aHVtYW4lMjBmYWNlfGVufDB8fDB8fA%3D%3D&w=1000&q=80"
                        alt="" srcset=""> -->
                    <img id='avt' src="{{ url_for( 'static',filename='MU.png' ) }}" alt="" srcset="">
                    <input accept="image/*" type='file' id="upload_image" style="display: none;" />
                    <div>
                        <label for="upload_image">
                            <img class="p-1" src="{{ url_for( 'static',filename='icons/editimage.png' )}}" alt="">
                            Thay đổi avatar
                        </label>
                    </div>
                </div>

                <!-- Body Right -->
                <div class="detail-info mx-3">
                    <div>
                        <label for="name_user">Tên người dùng</label>
                        <input type="text" name="" id="name_user" placeholder="vietdeptrai">
                    </div>
                    <div>
                        <label for="">Đổi mật khẩu</label>
                        <span id="icon-select"><i class="fa-solid fa-circle-check"></i></span>
                    </div>
                    <div class="input-pwd">
                        <label for="old-pwd">Nhập mật khẩu cũ</label>
                        <input type="password" name="" id="old-pwd" disabled>
                        <span><i class="fa-solid fa-eye-slash toggle-password"></i></span>
                    </div>
                    <div class="input-pwd">
                        <label for="new-pwd">Nhập mật khẩu mới</label>
                        <input type="password" name="" id="new-pwd" disabled>
                        <span><i class="fa-solid fa-eye-slash toggle-password"></i></span>
                    </div>
                    <div class="input-pwd">
                        <label for="repeat-new-pwd">Nhập lại mật khẩu mới</label>
                        <input type="password" name="" id="repeat-new-pwd" disabled>
                        <span><i class="fa-solid fa-eye-slash toggle-password"></i></span>
                    </div>


                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-modal btn-dismiss" data-bs-dismiss="modal">Hủy bỏ</button>
                <button type="button" class="btn btn-modal btn-change">Cập nhật</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Dialog Crop Image -->
<div id="uploadimageModal" class="modal" role="dialog">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Xem thử hình ảnh</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-center">
                    <div id="image_demo" style="width:350px; margin-top:30px;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" data-bs-dismiss="modal">Huỷ bỏ</button>
                <button class="btn btn-success crop_image">Cập nhật</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Alert -->
<div class="modal" tabindex="-1" role="dialog" id='modal-alert'>
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <!-- <div class="modal-header">
                <h5 class="modal-title">Thông báo</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div> -->
            <div class="modal-body d-flex align-items-center">
                <p class="w-100"></p>
            </div>
            <div class="modal-footer justify-content-center">
                <button value="0" id='update-change' type="button" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>
</div>

<style>
    .primary-color {
        color: #183758 !important;
    }

    #modal-personal {
        width: 100%;
    }

    #modal-personal .black-text {
        color: black !important;
    }

    #modal-personal .modal-header {
        border-bottom: none;
    }

    #modal-personal .modal-body {
        display: flex;
    }

    #modal-personal .modal-body .general-info {
        width: 30%;
        /* height: 100%; */
        text-align: center;
        border-right: 1px solid #dee2e6;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    #modal-personal .modal-footer {
        padding-right: 28px;
    }

    .general-info img#avt {
        width: 50%;
        /* height: 50%; */
        border-radius: 50%;
    }

    .general-info label {
        margin-top: 3vh;
        font-size: 16px;
        font-weight: 600;
    }

    .general-info label:hover {
        cursor: pointer;
    }

    #modal-personal .modal-footer {
        border-top: none;
    }

    .detail-info {
        width: 70%;
        height: auto;
    }

    .detail-info div {
        display: flex;
        align-items: center;
        padding-bottom: 16px;
    }

    .detail-info div label {
        min-width: 189px;
        font-size: 18px;
    }

    .detail-info div input {
        width: 100%;
        border-radius: 10px;
        padding-left: 8px;
        border: 2px solid #D1D1D1;
        border: 2px solid #b5aeae;
    }

    .detail-info div input:focus {
        outline: none;
    }

    .input-pwd label {
        color: #D1D1D1;
    }

    .input-pwd input {
        position: relative;
    }

    .input-pwd input:not([disabled])+span {
        cursor: pointer;
    }

    .input-pwd span {
        color: #d1d1d1;
        position: absolute;
        right: 40px;
        z-index: 1;
    }

    label {
        margin-bottom: 0;
    }

    #icon-select {
        color: #D1D1D1;
        cursor: pointer;
    }

    .btn-change {
        padding: 5px 30px;
        border-radius: 5px;
        border: none;
        background: #0066ff;
        color: white;
    }

    .btn-dismiss{
        background-color: #e1e1e1;
    }

    @media (min-width: 576px) {
        #modal-personal .modal-dialog {
            max-width: 774px;
        }
    }

    /*  Preview image  */
    .croppie-container {
        width: 100%;
        height: 100%;
    }

    .croppie-container .cr-boundary {
        position: relative;
        overflow: hidden;
        margin: 0 auto;
        z-index: 1;
    }

    .croppie-container .cr-image {
        z-index: -1;
        position: absolute;
        top: 0;
        left: 0;
    }

    .croppie-container .cr-vp-circle {
        border-radius: 50%;
    }

    .croppie-container .cr-overlay {
        z-index: 1;
        position: absolute;
        cursor: move;
        touch-action: none;
    }

    .croppie-container .cr-viewport {
        position: absolute;
        border: 2px solid #fff;
        margin: auto;
        top: 0;
        bottom: 0;
        right: 0;
        left: 0;
        box-shadow: 0 0 2000px 2000px rgba(0, 0, 0, 0.5);
        z-index: 0;
    }

    .croppie-container .cr-slider-wrap {
        width: 75%;
        margin: 15px auto;
        text-align: center;
    }

    /* Croppie Slider */
    .cr-slider {
        -webkit-appearance: none;
        /*removes default webkit styles*/
        /*border: 1px solid white; */
        /*fix for FF unable to apply focus style bug */
        width: 300px;
        /*required for proper track sizing in FF*/
        max-width: 100%;
        padding-top: 8px;
        padding-bottom: 8px;
        background-color: transparent;
    }

    .cr-slider::-webkit-slider-runnable-track {
        width: 100%;
        height: 3px;
        background: rgba(0, 0, 0, 0.5);
        border: 0;
        border-radius: 3px;
    }

    .cr-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        border: none;
        height: 16px;
        width: 16px;
        border-radius: 50%;
        background: #ddd;
        margin-top: -6px;
    }

    .cr-slider:focus {
        outline: none;
    }

    /* Modal Dialog Alert */
    #modal-alert .modal-content {
        width: 489px;
        min-height: 150px;
    }

    #modal-alert .modal-body p {
        font-size: 18px;
        font-weight: 700;
        color: #272643;
        text-align: center;
        margin: 0;
    }

    #modal-alert .modal-footer {
        border-top: none;
    }

    button#update-change {
        min-width: 126px;
        background-color: #2C698D;
    }
</style>

<script>

    //show/hide inputs password
    $("#icon-select").click(function () {
        $(this).toggleClass("primary-color")
        $(".input-pwd").each(function () {
            $(this).find("input").prop('disabled', function (index, value) { return !value; });
            $(this).find("label").toggleClass("black-text")
        })
    })

    //cursor pointer icon show/hide password
    if ($("input#old-pwd").prop("disabled") == false) {
        $(".input-pwd span").each(function () {
            $(this).css("cursor", "pointer")
        })
    }

    //toggle show/hide password
    $("span:has('.toggle-password')").click(function () {
        if ($("input#old-pwd").prop("disabled") == false) {
            $(this).find("i").toggleClass("fa-eye fa-eye-slash");
            // var input = $(".input-pwd input");
            var input = $(this).prev()
            if (input.attr("type") == "password") {
                input.attr("type", "text");
            } else {
                input.attr("type", "password");
            }
        }
    });

    //reset modal dialog if modal dialog closed
    $('#modal-personal').on('hidden.bs.modal', function (event) {
        $("#icon-select").each(function () {
            if ($(this).hasClass("primary-color")) {
                $(this).removeClass("primary-color")
            }
        })
        $(".input-pwd input").prop("disabled", true)
        $("#modal-personal input").val("")
        $(".input-pwd label").each(function () {
            if ($(this).hasClass("black-text")) {
                $(this).removeClass("black-text")
            }
        })
        $(".input-pwd span i").each(function () {
            if ($(this).hasClass("fa-eye")) {
                $(this).removeClass("fa-eye")
                $(this).addClass("fa-eye-slash")
            }
        })
    })

    // Crop Image
    $image_crop = $('#image_demo').croppie({
        enableExif: true,
        viewport: {
            width: 240,
            height: 240,
            type: 'circle'
        },
        boundary: {
            width: 300,
            height: 300
        }
    });

    //open modal crop image
    $('#upload_image').on('change', function () {
        var reader = new FileReader();
        reader.onload = function (event) {
            $image_crop.croppie('bind', {
                url: event.target.result
            }).then(function () {
                console.log('jQuery bind complete');
            });
        }
        reader.readAsDataURL(this.files[0]);
        $('#uploadimageModal').modal('show');
    });

    //reset input image if close dialog
    $('#uploadimageModal').on('hidden.bs.modal', function (event) {
        $("#upload_image").val("")
    })

    //update avatar 
    $('.crop_image').click(function (event) {
        $image_crop.croppie('result', {
            type: 'canvas',
            size: 'viewport'
        }).then(function (response) {
            $('#uploadimageModal').modal('hide');
            $('#modal-personal').modal('hide');
            // $("#wait-load").modal("show", {backdrop: 'static', keyboard: false});
            data = {}
            data['avatar'] = response;
            $.ajax({
                type: 'UPDATE',
                url: '/auth/avatar/',
                contentType: "application/json;charset=utf-8",
                data: JSON.stringify(data),
                dataType: 'json',
                success: function (response) {
                    // $("#wait-load").modal("hide");
                    if (response['status']) {
                        $('#modal-alert .modal-body p').text("Cập nhật ảnh đại diện thành công!");
                        $('#modal-alert').modal('show');
                        $('#update-change').val('2');
                    }
                    else {
                        $('#modal-alert .modal-body p').text("Không thể cập nhật hình ảnh đại diện!");
                        $('#modal-alert').modal('show');
                        $('#update-change').val('2');
                    }
                },
                error: function (error) {
                    // $("#wait-load").modal("hide");
                    console.log(error);
                }
            });
            // $('#avt').attr('src', response);
        })
    });

    //hàm validate password
    function validatePassword(pw) {
        return /[A-Z]/.test(pw) ||
            /[a-z]/.test(pw) &&
            /[0-9]/.test(pw) &&
            pw.length > 7;

    }


    // update information
    $('.btn-change').click(function () {
        //let image = $('#avt').attr('src');
        let data = {};
        // if (image.length > 200) {
        //     data['image'] = image;
        // }
        if ($('#old-pwd').val() != '') {
            data['pwd'] = $('#old-pwd').val();
            $('#modal-personal').modal('hide');
            if ($('#new-pwd').val() === $('#repeat-new-pwd').val() && $('#new-pwd').val() != '') {
                if (validatePassword($('#new-pwd').val())) {
                    //$("#wait-load").modal("show", { backdrop: 'static', keyboard: false });
                    data['new_pwd'] = $('#new-pwd').val();
                    if ($('#name_user').val() != '')
                        data['name_user'] = $('#name_user').val();
                    else
                        data['name_user'] = $('#name_user').attr('placeholder');

                    //gọi ajax update password
                    $.ajax({
                        type: 'UPDATE',
                        url: '/auth/users/',
                        contentType: "application/json;charset=utf-8",
                        data: JSON.stringify(data),
                        dataType: 'json',
                        success: function (response) {

                            //update password thành công

                            // $("#wait-load").modal("hide");
                            if (response['status']) {
                                //cập nhật password thành công thì cho reload lại trang
                                $('#modal-alert .modal-body p').text(response['msg']);
                                $('#modal-alert').modal('show');
                                // $('#update-change').val('0');
                                $('#update-change').val('2');
                            }
                            else {
                                $('#modal-alert .modal-body p').text(response['msg']);
                                $('#modal-alert').modal('show');
                                $('#update-change').val('1');
                            }
                        },
                        error: function (error) {

                            //$("#wait-load").modal("hide");
                            console.log(error);
                        }
                    });
                }
                else {
                    $('#modal-alert .modal-body p').text('Mật khẩu không đủ mạnh. Yêu cầu 8 kí tự a-z, A-Z, số, kí tự đặc biệt!');
                    $('#modal-alert').modal('show');
                    $('#update-change').val('1');
                }
            }
            else {
                $('#modal-alert .modal-body p').text('Mật khẩu nhập lại không khớp.');
                $('#modal-alert').modal('show');
                $('#update-change').val('1');
            }
        }
        else {
            $('#modal-personal').modal('hide');
            if ($('#name_user').val() != '') {
                data['name_user'] = $('#name_user').val();
                $.ajax({
                    type: 'UPDATE',
                    url: '/auth/users/',
                    contentType: "application/json;charset=utf-8",
                    data: JSON.stringify(data),
                    dataType: 'json',
                    success: function (response) {
                        // $("#wait-load").modal("hide");
                        if (response['status']) {
                            $('#modal-alert .modal-body p').text(response['msg']);
                            $('#modal-alert').modal('show');
                            $('#update-change').val('2');
                        }
                        else {
                            $('#modal-alert .modal-body p').text(response['msg']);
                            $('#modal-alert').modal('show');
                            $('#update-change').val('1');
                        }
                    },
                    error: function (error) {

                        //$("#wait-load").modal("hide");
                        console.log(error);
                    }
                });
            }
            else if ($('#new-pwd').val() = ! '') {
                $('#modal-alert .modal-body p').text('Chưa nhập mật khẩu cũ!');
                $('#modal-alert').modal('show');
                $('#update-change').val('1');
            }
            else {
                if ($('#new-pwd').val() = ! '') {
                    $('#modal-alert .modal-body p').text('Không có thông tin gì cần thay đổi!');
                    $('#modal-alert').modal('show');
                    $('#update-change').val('1');
                }
            }
        }
    });

    //modal alert closed
    $('#update-change').click(function () {
        $('#modal-alert').modal('hide');
        if ($('#update-change').val() == '0') {
            // $("#wait-load").modal("show", { backdrop: 'static', keyboard: false });
            window.location.replace("/auth/logout/");
        }
        else if ($('#update-change').val() == '1') {
            $('#modal-personal').modal('show');
        }
        else {
            // $("#wait-load").modal("show", { backdrop: 'static', keyboard: false });
            window.location.reload();
        }
    });

</script>